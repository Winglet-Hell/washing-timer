import logging
from telegram import Update
from telegram.ext import (
    Application,
    CommandHandler,
    MessageHandler,
    filters,
)
import asyncio

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    level=logging.INFO,
)
logger = logging.getLogger(__name__)


# –§—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—É /start
async def start(update: Update, context) -> None:
    logger.info(
        "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å %s –≤—ã–∑–≤–∞–ª –∫–æ–º–∞–Ω–¥—É /" "start", update.effective_user.first_name
    )
    # –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞
    await update.message.reply_text(
        "üëã –ü—Ä–∏–≤–µ—Ç!\n\n"
        "–Ø –ø–æ–º–æ–≥—É —Ç–µ–±–µ –Ω–∞–ø–æ–º–Ω–∏—Ç—å –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Å—Ç–∏—Ä–∫–∏ üß∫\n\n"
        "–í–≤–µ–¥–∏ –≤—Ä–µ–º—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ *–ß–ß–ú–ú* "
        "(–Ω–∞–ø—Ä–∏–º–µ—Ä, 0320 –¥–ª—è 3 —á–∞—Å–æ–≤ –∏ 20 –º–∏–Ω—É—Ç) ‚è±Ô∏è",
        parse_mode="Markdown",
    )


# –§—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –≤–≤–æ–¥–æ–º –≤—Ä–µ–º–µ–Ω–∏
async def handle_time(update: Update, context) -> None:
    try:
        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        time_str = update.message.text
        logger.info(
            "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å %s –≤–≤–µ–ª –≤—Ä–µ–º—è: %s", update.effective_user.first_name, time_str
        )

        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤–≤–µ–¥–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è –≤ —á–∞—Å—ã –∏ –º–∏–Ω—É—Ç—ã
        hours = int(time_str[:2])
        minutes = int(time_str[2:])
        logger.info("–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è: %d —á–∞—Å–æ–≤ –∏ %d –º–∏–Ω—É—Ç", hours, minutes)

        # –í—ã—á–∏—Å–ª—è–µ–º –æ–±—â–µ–µ –≤—Ä–µ–º—è –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
        total_time_seconds = hours * 3600 + minutes * 60

        # –°–æ–æ–±—â–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, —á—Ç–æ —Ç–∞–π–º–µ—Ä —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –Ω–∞—á–∞–ª—Å—è –æ—Ç—Å—á–µ—Ç
        await update.message.reply_text(
            f"‚è≥ –¢–∞–π–º–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ *{hours} —á–∞—Å–æ–≤ –∏ {minutes} –º–∏–Ω—É—Ç* üï∞Ô∏è\n\n"
            "–Ø –Ω–∞–ø–æ–º–Ω—é —Ç–µ–±–µ, –∫–æ–≥–¥–∞ —Å—Ç–∏—Ä–∫–∞ –±—É–¥–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∞ üòâ",
            parse_mode="Markdown",
        )
        logger.info("–¢–∞–π–º–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ %d —Å–µ–∫—É–Ω–¥", total_time_seconds)

        # –ñ–¥–µ–º –æ–∫–æ–Ω—á–∞–Ω–∏—è –∑–∞–¥–∞–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
        await asyncio.sleep(total_time_seconds)

        # –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ–± –æ–∫–æ–Ω—á–∞–Ω–∏–∏ –≤—Ä–µ–º–µ–Ω–∏
        await update.message.reply_text(
            "‚úÖ *–í—Ä–µ–º—è —Å—Ç–∏—Ä–∫–∏ –ø–æ–¥–æ—à–ª–æ –∫ –∫–æ–Ω—Ü—É!* "
            "–ú–æ–∂–µ—à—å –∑–∞–±–∏—Ä–∞—Ç—å –±–µ–ª—å–µ –∏–∑ —Å—Ç–∏—Ä–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã üßº",
            parse_mode="Markdown",
        )
        logger.info(
            "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é %s –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Å—Ç–∏—Ä–∫–∏",
            update.effective_user.first_name,
        )

    except ValueError:
        # –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ, –µ—Å–ª–∏ —Ñ–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏ –≤–≤–µ–¥–µ–Ω –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ
        await update.message.reply_text(
            "‚ùå *–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏* üòÖ\n\n"
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏ –≤—Ä–µ–º—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ *–ß–ß–ú–ú* üï∞Ô∏è\n\n"
            "–ù–∞–ø—Ä–∏–º–µ—Ä, 0320 –¥–ª—è 3 —á–∞—Å–æ–≤ –∏ 20 –º–∏–Ω—É—Ç ‚è±Ô∏è",
            parse_mode="Markdown",
        )
        logger.error(
            "–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –≤—Ä–µ–º–µ–Ω–∏: %s –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è %s",
            time_str,
            update.effective_user.first_name,
        )


# –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞
def main() -> None:
    # –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ –¥–æ–±–∞–≤–ª—è–µ–º —Ç–æ–∫–µ–Ω –≤–∞—à–µ–≥–æ –±–æ—Ç–∞
    application = (
        Application.builder()
        .token("6843156829:AAFc9qweDJUQFkCxZk-SZ7QW087tBlg5_Oc")
        .build()
    )

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /start: –¥–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –≤—ã–∑–≤–∞–Ω–∞
    # –ø—Ä–∏ –≤–≤–æ–¥–µ /start
    application.add_handler(CommandHandler("start", start))

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —è–≤–ª—è—é—Ç—Å—è –∫–æ–º–∞–Ω–¥–∞–º–∏
    application.add_handler(
        MessageHandler(filters.TEXT & ~filters.COMMAND, handle_time)
    )

    # –°–æ–æ–±—â–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, —á—Ç–æ –±–æ—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ, –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –µ–≥–æ
    logger.info("üöÄ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –ø—Ä–∏–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏–π")
    print("üöÄ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –ø—Ä–∏–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏–π")

    # –ó–∞–ø—É—Å–∫ –º–µ—Ç–æ–¥–∞ polling, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –æ–ø—Ä–∞—à–∏–≤–∞—Ç—å —Å–µ—Ä–≤–µ—Ä Telegram
    # –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    application.run_polling(timeout=0)
    # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –¥–æ 60 —Å–µ–∫—É–Ω–¥


if __name__ == "__main__":
    main()
